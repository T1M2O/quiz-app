<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="google" content="notranslate">
  <title>ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f8ff">
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">

  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; background-color: #f0f8ff; margin: 0; padding: 20px; color: #333; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
    .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; min-height: 500px; display: flex; flex-direction: column; position: relative; }
    input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white; -webkit-appearance: none; appearance: none; }
    
    .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; text-decoration: none; box-sizing: border-box; }
    .btn:active { transform: scale(0.98); }
    .btn-city { background: #00B900; }
    .btn-tour { background: #E67E22; }
    .btn-review { background: #dc3545; }
    .btn-stats { background: #6f42c1; }
    .btn-giveup { background: #6c757d; margin-top: 5px; }
    .btn-dummy { background: #e0e0e0; color: #888; cursor: not-allowed; }
    .btn-choice { background: #f8f9fa; color: #333; border: 2px solid #007bff; }
    
    .hidden { display: none !important; }
    .stats-bar { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; }
    .stats-item span { font-size: 18px; font-weight: bold; color: #ffc107; margin-left: 5px; }
    
    .quiz-header { font-size: 14px; color: #666; margin-bottom: 5px; }
    .quiz-text { font-size: 24px; font-weight: bold; margin: 15px 0; min-height: 1.2em; line-height: 1.4; white-space: pre-wrap; }
    .quiz-img { max-height: 200px; width: auto; max-width: 100%; border-radius: 8px; object-fit: contain; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .result-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; overflow-y: auto; padding: 20px 0;}
    .res-icon { font-size: 80px; margin-bottom: 10px; }
    .res-text { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
    .correct-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 20px; width: 80%; }
    
    .news-box { text-align: left; background: #fff3cd; border: 1px solid #ffeeba; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; max-height: 150px; overflow-y: hidden; }
    .news-item { margin-bottom: 4px; color: #555; }
    .news-date { font-weight: bold; margin-right: 5px; color: #856404; }

    .settings-icon { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; z-index: 100; transition: transform 0.3s; }
    .settings-icon:active { transform: rotate(90deg); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; position: relative; max-height: 90vh; overflow-y: auto;}
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .settings-list { list-style: none; padding: 0; margin: 0; text-align: left; }
    .settings-list li { padding: 15px 5px; border-bottom: 1px solid #eee; font-size: 16px; display: flex; align-items: center; cursor: pointer; }
    .settings-list li:last-child { border-bottom: none; }
    .settings-list li span.icon { margin-right: 10px; font-size: 20px; }
    
    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #00B900; }
    input:checked + .slider:before { transform: translateX(24px); }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .stats-card { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #007bff; }
    .progress-bg { background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .progress-bar { height: 100%; width: 0%; transition: width 0.5s; }
    
    .help-section { text-align: left; margin-bottom: 15px; font-size: 14px; color: #444; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
    .help-section h4 { margin: 0 0 5px 0; color: #007bff; }
  </style>
</head>
<body>

  <div id="image-viewer" class="modal-overlay hidden" style="z-index: 100000; background: rgba(0,0,0,0.95); flex-direction: column;" onclick="closeImageViewer()">
    <div style="width: 100%; text-align: right; padding: 20px; box-sizing: border-box;"><span style="color: white; font-size: 30px; cursor: pointer; font-weight: bold;">âœ–</span></div>
    <img id="viewer-img" src="" style="max-width: 95%; max-height: 80%; object-fit: contain; border-radius: 8px;">
    <div style="color: white; margin-top: 15px; font-size: 14px;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
  </div>

  <div id="custom-alert" class="modal-overlay hidden" style="z-index: 100001;">
    <div class="modal-content">
      <p id="alert-msg" style="font-size:16px; margin-bottom:20px; line-height:1.5;"></p>
      <button class="btn" onclick="closeAlert()" style="margin:0;">OK</button>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-size:18px; font-weight:bold;">æº–å‚™ä¸­...</div>
  </div>

  <div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content" style="padding:15px;">
      <h3 style="margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px;">âš™ï¸ è¨­å®š</h3>
      <ul class="settings-list">
        <li onclick="openSubModal('sound-modal')"><span class="icon">ğŸµ</span> ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</li>
        <li onclick="openSubModal('account-modal')"><span class="icon">ğŸ‘¤</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ² / å¤‰æ›´</li>
        <li onclick="openSubModal('login-modal')"><span class="icon">ğŸ”„</span> æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</li>
        <li onclick="openSubModal('admin-modal')"><span class="icon">ğŸ”‘</span> ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</li>
        <li onclick="openSubModal('help-modal')"><span class="icon">ğŸ“–</span> ä½¿ã„æ–¹èª¬æ˜</li>
        <li onclick="logout()" style="color:#dc3545;"><span class="icon">ğŸšª</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
        <li onclick="openSubModal('delete-modal')" style="color:#dc3545;"><span class="icon">âš ï¸</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</li>
      </ul>
      <button class="btn" style="background:#6c757d; margin-bottom:0;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="sound-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸµ ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
      <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0;">
        <span style="font-weight:bold;">åŠ¹æœéŸ³</span>
        <label class="toggle-switch">
          <input type="checkbox" id="sound-toggle" onchange="toggleSound()">
          <span class="slider"></span>
        </label>
      </div>
      <div id="volume-container" style="margin-bottom: 30px; text-align:left;">
        <label style="font-weight:bold; display:flex; justify-content:space-between; margin-bottom:10px;">
          <span>éŸ³é‡</span>
          <span id="vol-display" style="color:#007bff; font-size:18px;">50</span>
        </label>
        <input type="range" id="sound-vol" min="0" max="100" step="1" value="50" style="width:100%; margin:0;" oninput="changeVolume()" onchange="saveVolume()">
      </div>
      <button class="btn" style="background:#6c757d; margin:0;" onclick="closeSubModal('sound-modal')">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="account-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
      <p style="font-size:12px; color:#666;">ãŠå¥½ããªãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã’ã‚‹æœ¬ç™»éŒ²ã‚’ã—ã¾ã—ã‚‡ã†ï¼</p>
      <input type="text" id="edit-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
      <input type="password" id="edit-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('account-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#00B900; flex:1; margin:0;" onclick="updateAccount()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="login-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³</h3>
      <p style="font-size:12px; color:#666;">ä»¥å‰ä½œæˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¼•ãç¶™ãã¾ã™ã€‚</p>
      <input type="text" id="manual-login-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
      <input type="password" id="manual-login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('login-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#00B900; flex:1; margin:0;" onclick="manualLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0; color:#dc3545;">âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</h3>
      <p style="font-size:13px; color:#333; line-height:1.5;">æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <input type="text" id="delete-confirm" placeholder="ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„" style="border-color:#dc3545;">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('delete-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#dc3545; flex:1; margin:0;" onclick="deleteAccount()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="help-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-height: 70vh;">
      <h3 style="margin-top:0;">ğŸ“– ä½¿ã„æ–¹èª¬æ˜</h3>
      <div class="help-section">
        <h4>ğŸ™ å¸‚ç”ºæ‘ / â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º</h4>
        è¡¨ç¤ºã•ã‚ŒãŸç”»åƒã®å ´æ‰€ãŒã©ã®éƒ½é“åºœçœŒã«ã‚ã‚‹ã‹ã‚’å½“ã¦ã‚‹ã‚¯ã‚¤ã‚ºã§ã™ã€‚ä¸æ­£è§£ã ã£ãŸå•é¡Œã¯è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
      </div>
      <div class="help-section">
        <h4>ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</h4>
        ã“ã‚Œã¾ã§ã«é–“é•ãˆãŸå•é¡Œã ã‘ãŒãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã¾ã™ã€‚æ­£è§£ã™ã‚‹ã¨è‹¦æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
      </div>
      <div class="help-section">
        <h4>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¤ã„ã¦</h4>
        åˆå›ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§éŠã¹ã¾ã™ãŒã€è¨­å®šï¼ˆâš™ï¸ï¼‰ã‹ã‚‰åå‰ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ä»–ã®ç«¯æœ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã’ã¾ã™ã€‚
      </div>
      <button class="btn" style="background:#6c757d; margin:0; margin-top:15px;" onclick="closeSubModal('help-modal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="admin-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ”‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</h3>
      <p style="font-size:12px; color:#666;">ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="password" id="admin-pass-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom:20px;">
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('admin-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#007bff; flex:1; margin:0;" onclick="checkAdmin()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="news-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ“¢ ãŠçŸ¥ã‚‰ã›ä¸€è¦§</h3>
      <div id="full-news-list" style="max-height: 60vh; overflow-y:auto; text-align:left; font-size:13px;"></div>
      <button class="btn" style="background:#6c757d; margin-top:15px;" onclick="closeSubModal('news-modal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="startup-screen" class="card hidden">
    <h1 style="color:#00B900;">ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</h1>
    <p id="startup-msg" style="color:#dc3545; font-size:14px; margin-bottom:20px;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
    <button class="btn btn-city" onclick="performGuestLogin()">ğŸš€ ã‚²ã‚¹ãƒˆã¨ã—ã¦å†è©¦è¡Œã™ã‚‹</button>
    
    <hr style="margin:25px 0; border:0; border-top:1px dashed #ccc;">
    
    <p style="font-size:13px; margin-bottom:5px; color:#666;">â–¼ ã™ã§ã«æœ¬ç™»éŒ²æ¸ˆã¿ã®æ–¹ã¯ã“ã¡ã‚‰</p>
    <input type="text" id="retry-login-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
    <input type="password" id="retry-login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" style="background:#6c757d;" onclick="retryManualLogin()">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å†é–‹</button>
  </div>

  <div id="menu-screen" class="card hidden">
    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
    <div class="stats-bar" id="menu-stats" style="margin-top:30px;"></div>
    
    <div id="news-box" class="news-box hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
        <button class="btn" style="padding:4px 8px; margin:0; width:auto; font-size:11px; background:#6c757d; border-radius:4px;" onclick="openSubModal('news-modal')">ãŠçŸ¥ã‚‰ã›ä¸€è¦§</button>
      </div>
      <div id="news-list"></div>
    </div>

    <button class="btn btn-city" onclick="startGame('city')">ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º</button>
    <button class="btn btn-tour" onclick="startGame('tourist')">â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º</button>
    
    <button class="btn btn-dummy" style="margin-top:10px;" onclick="myAlert('é›£èª­åœ°åã‚¯ã‚¤ã‚ºã¯è¿½åŠ äºˆå®šã§ã™ï¼')">ğŸ”’ è¿½åŠ äºˆå®šãƒ¢ãƒ¼ãƒ‰â‘ </button>
    <button class="btn btn-dummy" style="margin-top:10px;" onclick="myAlert('ã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚¯ã‚¤ã‚ºã¯è¿½åŠ äºˆå®šã§ã™ï¼')">ğŸ”’ è¿½åŠ äºˆå®šãƒ¢ãƒ¼ãƒ‰â‘¡</button>

    <button class="btn btn-review" style="margin-top:10px;" onclick="startReview()">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="btn btn-stats" style="margin-top:10px;" onclick="showStatsDetail()">ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</button>
  </div>

  <div id="stats-detail-screen" class="card hidden">
    <h2 style="margin-top:0;">ğŸ“Š ãƒ—ãƒ¬ã‚¤ãƒ‡ãƒ¼ã‚¿</h2>
    <div id="stats-content"></div>
    <button class="btn" onclick="backToMenu()">æˆ»ã‚‹</button>
  </div>

  <div id="game-screen" class="card hidden">
    <div class="stats-bar" id="game-stats">
      <div class="stats-item">æ­£è§£æ•°: <span id="st-correct">0</span></div>
      <div class="stats-item">æ­£è§£ç‡: <span id="st-rate">0%</span></div>
    </div>
    
    <div id="review-banner" class="hidden" style="background:#dc3545; color:white; font-size:12px; padding:2px; margin-bottom:5px; border-radius:4px;">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­</div>

    <div id="quiz-area">
      <div class="quiz-header" id="q-header">ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ</div>
      <div id="q-img-container"></div>
      <div class="quiz-text" id="q-text"></div>
    </div>
    
    <div style="margin-top: auto;">
      <div id="normal-answer-area">
        <select id="answer-select"><option value="" disabled selected>éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        <button class="btn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
        <button class="btn btn-giveup" onclick="giveUp()">ğŸ³ï¸ åˆ†ã‹ã‚‰ãªã„</button>
      </div>

      <div id="hidden-answer-area" class="hidden">
        <button class="btn btn-choice" id="btn-choice-0" onclick="submitHiddenAnswer(0)"></button>
        <button class="btn btn-choice" id="btn-choice-1" onclick="submitHiddenAnswer(1)"></button>
        <button class="btn btn-choice" id="btn-choice-2" onclick="submitHiddenAnswer(2)"></button>
        <button class="btn btn-choice" id="btn-choice-3" onclick="submitHiddenAnswer(3)"></button>
      </div>

      <div style="text-align:center; margin-top:15px;"><button class="btn" style="background:transparent; color:#999; border:none; width:auto; display:inline-block; font-size:12px; padding:5px;" onclick="backToMenu()">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button></div>
    </div>

    <div id="result-overlay" class="result-overlay hidden">
      <div class="res-icon" id="res-icon"></div>
      <div class="res-text" id="res-text"></div>
      <div class="correct-box">
        <span style="font-size:12px; color:#666;">æ­£è§£ã¯...</span><br>
        <span id="res-ans" style="font-size:28px; font-weight:bold; color:#007bff; display:block; margin-bottom:10px;"></span>
        <div id="exp-img-container"></div>
      </div>
      
      <div id="link-container" style="display:flex; gap:10px; width:90%; margin-bottom: 20px;">
        <a id="link-map" target="_blank" class="btn" style="background:#4285F4; flex:1; margin:0; padding:10px 0; font-size:14px;">ğŸ—ºï¸ GoogleMap</a>
        <a id="link-wiki" target="_blank" class="btn" style="background:#333; flex:1; margin:0; padding:10px 0; font-size:14px;">ğŸ“– Wikipedia</a>
      </div>

      <button class="btn btn-next" style="width:90%;" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â¡</button>
    </div>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzv0Gz2d0Ex0NDW8MHuHX6tCKqtGGsUfXrqhQFnar0F0Xw9y5RaFDKz13JZQTh_x2Nk/exec";
    
    let myUserId = null;
    let appData = { stats: null, city: [], tourist: [], news: [], hidden: [] };
    let currentMode = null; let currentQuestion = null; let wrongList = null; 
    let currentChoices = []; let hiddenQueue = []; 

    const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

    // ===== ã‚µã‚¦ãƒ³ãƒ‰æ©Ÿèƒ½ =====
    let audioCtx;
    let soundEnabled = (localStorage.getItem('quiz_app_sound') !== 'false');
    let soundVol = parseInt(localStorage.getItem('quiz_app_vol')) || 50;

    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    document.addEventListener('touchstart', initAudio, { once: true });
    document.addEventListener('click', initAudio, { once: true });

    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn') || e.target.closest('.settings-list li') || e.target.closest('.settings-icon')) {
        playTone(600, 'sine', 0.05, 0.3);
      }
    });

    function playTone(freq, type, duration, volScale) {
      if (!soundEnabled || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      const actualVol = (soundVol / 100) * volScale;
      gain.gain.setValueAtTime(actualVol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function playCorrectSound() { playTone(880, 'sine', 0.1, 0.5); setTimeout(() => playTone(1108, 'sine', 0.3, 0.5), 100); }
    function playWrongSound() { playTone(300, 'sawtooth', 0.3, 0.5); }

    function updateVolUI() {
      const volContainer = document.getElementById('volume-container');
      const volSlider = document.getElementById('sound-vol');
      const volDisplay = document.getElementById('vol-display');
      if (soundEnabled) {
        volContainer.style.opacity = "1"; volContainer.style.pointerEvents = "auto";
        volSlider.disabled = false; volDisplay.innerText = soundVol;
      } else {
        volContainer.style.opacity = "0.4"; volContainer.style.pointerEvents = "none";
        volSlider.disabled = true; volDisplay.innerText = "OFF";
      }
    }
    function toggleSound() {
      soundEnabled = document.getElementById('sound-toggle').checked;
      localStorage.setItem('quiz_app_sound', soundEnabled);
      updateVolUI();
      if(soundEnabled) { initAudio(); playTone(880, 'sine', 0.1, 0.3); }
    }
    function changeVolume() {
      soundVol = document.getElementById('sound-vol').value;
      document.getElementById('vol-display').innerText = soundVol;
    }
    function saveVolume() {
      localStorage.setItem('quiz_app_vol', soundVol);
      playTone(600, 'sine', 0.1, 0.3);
    }
    // =====================================

    window.onload = function() {
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
      const select = document.getElementById('answer-select');
      prefectures.forEach(pref => {
        const option = document.createElement('option'); option.value = pref; option.textContent = pref; select.appendChild(option);
      });
      
      document.getElementById('sound-toggle').checked = soundEnabled;
      document.getElementById('sound-vol').value = soundVol;
      updateVolUI();

      const storedId = localStorage.getItem('quiz_app_userid');
      const storedName = localStorage.getItem('quiz_app_name');
      const storedPass = localStorage.getItem('quiz_app_pass');
      
      if (storedId && storedName && storedPass) {
        performLogin(storedName, storedPass, false);
      } else {
        performGuestLogin();
      }
    };

    function myAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('custom-alert').classList.remove('hidden'); }
    function closeAlert() { document.getElementById('custom-alert').classList.add('hidden'); }
    function openImageViewer(src) { document.getElementById('viewer-img').src = src; document.getElementById('image-viewer').classList.remove('hidden'); }
    function closeImageViewer() { document.getElementById('image-viewer').classList.add('hidden'); document.getElementById('viewer-img').src = ""; }

    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    function openSubModal(id) {
      closeSettings(); document.getElementById(id).classList.remove('hidden');
      if(id === 'account-modal') {
        document.getElementById('edit-name').value = localStorage.getItem('quiz_app_name') || "";
        document.getElementById('edit-pass').value = localStorage.getItem('quiz_app_pass') || "";
      }
    }
    function closeSubModal(id) { document.getElementById(id).classList.add('hidden'); openSettings(); }

    // --- â˜…ã‚¨ãƒ©ãƒ¼æ™‚ã«çœŸã£ç™½ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ãƒªã‚«ãƒãƒªãƒ¼é–¢æ•° ---
    function showStartupError(msg) {
      hideLoading();
      hideAll();
      document.getElementById('startup-msg').innerHTML = msg + "<br>é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
      document.getElementById('startup-screen').classList.remove('hidden');
    }

    async function performGuestLogin() {
      showLoading("æº–å‚™ä¸­...");
      hideAll();
      try {
        const res = await fetch(`${GAS_API_URL}?action=guestLogin`).then(r => r.json());
        
        // â˜…GASã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ï¼ˆæ›´æ–°å¿˜ã‚Œï¼‰å ´åˆã®ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
        if (res.error === "Invalid Action") {
          return showStartupError("ã€é–‹ç™ºè€…ã‚¨ãƒ©ãƒ¼ã€‘<br>GASãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã€Œæ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã«æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        }
        
        onDataLoaded(res);
      } catch(e) { 
        showStartupError("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); 
      }
    }

    function manualLogin() {
      const name = document.getElementById('manual-login-name').value;
      const pass = document.getElementById('manual-login-pass').value;
      if(!name || !pass) return myAlert("å…¥åŠ›ã—ã¦ãã ã•ã„");
      closeSubModal('login-modal');
      showLoading("ãƒ­ã‚°ã‚¤ãƒ³ä¸­...");
      performLogin(name, pass, true);
    }
    
    function retryManualLogin() {
      const name = document.getElementById('retry-login-name').value;
      const pass = document.getElementById('retry-login-pass').value;
      if(!name || !pass) return myAlert("å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("ãƒ­ã‚°ã‚¤ãƒ³ä¸­...");
      performLogin(name, pass, true);
    }

    async function performLogin(name, pass, isManual = false) {
      try {
        const url = `${GAS_API_URL}?action=login&name=${encodeURIComponent(name)}&pass=${encodeURIComponent(pass)}`;
        const res = await fetch(url).then(r => r.json());
        
        if (res.success) {
          if (isManual) {
            localStorage.setItem('quiz_app_userid', res.userId);
            localStorage.setItem('quiz_app_name', res.name);
            localStorage.setItem('quiz_app_pass', res.pass);
            window.location.reload();
          } else {
            onDataLoaded(res);
          }
        } else {
          if (isManual) {
            hideLoading();
            myAlert(res.message);
          } else {
            // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã‚¨ãƒ©ãƒ¼ç”»é¢ã¸
            localStorage.clear();
            showStartupError("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          }
        }
      } catch(e) { 
        if (isManual) {
          hideLoading();
          myAlert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); 
        } else {
          showStartupError("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      }
    }

    async function updateAccount() {
      const newName = document.getElementById('edit-name').value;
      const newPass = document.getElementById('edit-pass').value;
      if (!newName || !newPass) return myAlert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      showLoading("æ›´æ–°ä¸­...");
      try {
        const res = await fetch(`${GAS_API_URL}?action=updateAccount&userId=${myUserId}&newName=${encodeURIComponent(newName)}&newPass=${encodeURIComponent(newPass)}`).then(r => r.json());
        hideLoading();
        if (res.success) {
          localStorage.setItem('quiz_app_name', newName); localStorage.setItem('quiz_app_pass', newPass);
          myAlert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼"); closeSubModal('account-modal');
        } else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function deleteAccount() {
      const confirmText = document.getElementById('delete-confirm').value;
      if (confirmText !== "å‰Šé™¤") return myAlert("ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("å‰Šé™¤ä¸­...");
      try {
        const res = await fetch(`${GAS_API_URL}?action=deleteAccount&userId=${myUserId}`).then(r => r.json());
        hideLoading();
        if (res.success) {
          alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚"); 
          logout();
        } else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function checkAdmin() {
      const pass = document.getElementById('admin-pass-input').value;
      if (!pass) return myAlert("ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("èªè¨¼ä¸­...");
      try {
        const res = await fetch(`${GAS_API_URL}?action=checkAdmin&pass=${encodeURIComponent(pass)}`).then(r => r.json());
        hideLoading(); document.getElementById('admin-modal').classList.add('hidden');
        if (res.success) { appData.hidden = res.hiddenQuiz; startHiddenQuiz(); } 
        else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
    }

    function onDataLoaded(res) {
      hideLoading();
      
      if (!res.success) {
        return showStartupError(res.message || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }

      const currentVersion = localStorage.getItem('quiz_app_version') || 1.0;
      if (res.appVersion && parseFloat(res.appVersion) > parseFloat(currentVersion)) {
        localStorage.setItem('quiz_app_version', res.appVersion); 
        myAlert("ğŸš€ ã‚¢ãƒ—ãƒªã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™ã€‚");
        setTimeout(() => { window.location.href = window.location.pathname + "?v=" + new Date().getTime(); }, 2000);
        return;
      }
      
      localStorage.setItem('quiz_app_userid', res.userId);
      localStorage.setItem('quiz_app_name', res.name);
      localStorage.setItem('quiz_app_pass', res.pass);
      
      myUserId = res.userId; appData.stats = res.stats; appData.city = res.masterData.city;
      appData.tourist = res.masterData.tourist; appData.news = res.news || []; 
      wrongList = null;
      document.getElementById('loading-overlay').classList.add('hidden');
      showMenu();
    }

    function showMenu() {
      hideAll(); document.getElementById('menu-screen').classList.remove('hidden');
      if(appData.stats) document.getElementById('menu-stats').innerHTML = `<div class="stats-item">æ­£è§£æ•°: <span>${appData.stats.total.correct}</span></div><div class="stats-item">æ­£è§£ç‡: <span>${appData.stats.total.rate}%</span></div>`;
      
      if (appData.news && appData.news.length > 0) {
        document.getElementById('news-box').classList.remove('hidden');
        let topHtml = ''; let fullHtml = '';
        appData.news.forEach((n, i) => { 
          if(i < 3) topHtml += `<div class="news-item"><span class="news-date">${n.date}</span> ${n.msg}</div>`; 
          fullHtml += `<div class="news-item" style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><span class="news-date" style="display:block; margin-bottom:3px;">${n.date}</span> ${n.msg}</div>`;
        });
        document.getElementById('news-list').innerHTML = topHtml;
        document.getElementById('full-news-list').innerHTML = fullHtml;
      } else { document.getElementById('news-box').classList.add('hidden'); }
    }

    async function startReview() {
      if (wrongList === null) {
        showLoading("å¾©ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
        try {
          const res = await fetch(`${GAS_API_URL}?action=getWrongList&userId=${myUserId}`).then(r => r.json());
          if (res.wrongList) wrongList = res.wrongList; else throw new Error();
          hideLoading();
        } catch(e) { hideLoading(); return myAlert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
      }
      if (wrongList.length === 0) return myAlert("å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼å„ªç§€ï¼");
      currentMode = 'review'; document.getElementById('review-banner').classList.remove('hidden');
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden');
    }

    function startHiddenQuiz() {
      currentMode = 'hidden'; document.getElementById('review-banner').classList.add('hidden');
      hiddenQueue = [...appData.hidden]; hiddenQueue.sort(() => Math.random() - 0.5);
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden'); 
    }

    async function syncScore(isCorrect, syncType, wrongId) {
      if (currentMode === 'hidden') return; 
      try {
        const res = await fetch(`${GAS_API_URL}?action=sync&userId=${myUserId}&mode=${currentMode}&isCorrect=${isCorrect}&syncType=${syncType}&wrongId=${encodeURIComponent(wrongId)}`).then(r => r.json());
        if(res) appData.stats = res;
      } catch(e) {}
    }
    
    function hideAll() { ['startup-screen','menu-screen','game-screen','stats-detail-screen'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
    function showLoading(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    
    function showStatsDetail() {
      hideAll(); document.getElementById('stats-detail-screen').classList.remove('hidden');
      document.getElementById('stats-content').innerHTML = `${createStatsCard("ç·åˆãƒ‡ãƒ¼ã‚¿", appData.stats.total, "#007bff")}${createStatsCard("ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º", appData.stats.city, "#28a745")}${createStatsCard("â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º", appData.stats.tourist, "#e67e22")}`;
    }

    function createStatsCard(title, obj, color) {
      let rateVal = (obj.total > 0) ? ((obj.correct / obj.total) * 100) : 0;
      return `<div class="stats-card" style="border-left-color: ${color}"><h3>${title}</h3><div class="stats-row"><span>å›ç­”æ•°</span><span class="stats-val">${obj.total} å•</span></div><div class="stats-row"><span>æ­£è§£æ•°</span><span class="stats-val">${obj.correct} å•</span></div><div class="progress-bg"><div class="progress-bar" style="width:${rateVal}%; background:${color};"></div></div><div style="text-align:right; font-size:12px; margin-top:2px;">æ­£è§£ç‡: ${obj.rate}%</div></div>`;
    }

    function startGame(mode) {
      currentMode = mode;
      const dataset = (mode === 'city') ? appData.city : appData.tourist;
      if (!dataset || dataset.length === 0) return myAlert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
      document.getElementById('review-banner').classList.add('hidden');
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden');
    }
    
    function backToMenu() { showMenu(); }
    function logout() { localStorage.clear(); location.reload(); }

    function nextQuestion() {
      document.getElementById('result-overlay').classList.add('hidden');
      if (currentMode === 'hidden') {
        document.getElementById('normal-answer-area').classList.add('hidden'); document.getElementById('hidden-answer-area').classList.remove('hidden');
        document.getElementById('q-header').innerText = "ãŠ™ï¸ éš ã—ã‚¯ã‚¤ã‚º ãŠ™ï¸"; document.getElementById('st-correct').innerText = "ãŠ™ï¸"; document.getElementById('st-rate').innerText = "éš ã‚Œ";
        if (hiddenQueue.length === 0) {
          document.getElementById('q-text').innerText = "ã™ã¹ã¦ã®éš ã—ã‚¯ã‚¤ã‚ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ğŸ‰\nã‚‚ã†å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          document.getElementById('q-img-container').innerHTML = ""; document.getElementById('hidden-answer-area').classList.add('hidden'); 
          return;
        }
        currentQuestion = hiddenQueue.pop();
        currentChoices = [currentQuestion.a, currentQuestion.w1, currentQuestion.w2, currentQuestion.w3].sort(() => Math.random() - 0.5); 
        for (let i = 0; i < 4; i++) { document.getElementById('btn-choice-' + i).innerText = currentChoices[i]; }
      } else {
        document.getElementById('normal-answer-area').classList.remove('hidden'); document.getElementById('hidden-answer-area').classList.add('hidden');
        document.getElementById('q-header').innerText = "ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ";
        if (currentMode === 'review') {
          if (!wrongList || wrongList.length === 0) { myAlert("å¾©ç¿’å®Œäº†ï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚"); return backToMenu(); }
          const randKey = wrongList[Math.floor(Math.random() * wrongList.length)];
          currentQuestion = appData.city.find(item => (item.q + "_" + item.a) === randKey) || appData.tourist.find(item => (item.q + "_" + item.a) === randKey);
          if (!currentQuestion) { wrongList = wrongList.filter(k => k !== randKey); return nextQuestion(); }
          document.getElementById('st-correct').innerText = "-"; document.getElementById('st-rate').innerText = "å¾©ç¿’";
        } else {
          const dataset = (currentMode === 'city') ? appData.city : appData.tourist;
          currentQuestion = dataset[Math.floor(Math.random() * dataset.length)];
          const s = appData.stats[currentMode];
          document.getElementById('st-correct').innerText = s.correct + '/' + s.total; document.getElementById('st-rate').innerText = s.rate + '%';
        }
      }
      document.getElementById('answer-select').selectedIndex = 0;
      document.getElementById('q-text').innerText = currentQuestion.q;
      document.getElementById('q-img-container').innerHTML = currentQuestion.i ? `<img src="${currentQuestion.i}" class="quiz-img">` : '';
    }

    function submitAnswer() {
      const v = document.getElementById('answer-select').value;
      if(!v) return myAlert("éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„"); processAnswer(v);
    }
    function giveUp() { processAnswer("GIVE_UP"); }
    function submitHiddenAnswer(index) { processAnswer(currentChoices[index]); }

    function processAnswer(ans) {
      const isCorrect = (ans === currentQuestion.a); let syncType = 'none'; let qKey = "";
      if (currentMode !== 'hidden') {
        qKey = currentQuestion.q + "_" + currentQuestion.a;
        if (currentMode === 'review') {
          if (isCorrect) { wrongList = wrongList.filter(k => k !== qKey); syncType = 'remove'; }
        } else {
          const s = appData.stats[currentMode]; s.total++; if(isCorrect) s.correct++; s.rate = (s.total>0) ? ((s.correct/s.total)*100).toFixed(1) : "0.0";
          const t = appData.stats.total; t.total++; if(isCorrect) t.correct++; t.rate = (t.total>0) ? ((t.correct/t.total)*100).toFixed(1) : "0.0";
          if (!isCorrect) { if (wrongList && !wrongList.includes(qKey)) wrongList.push(qKey); syncType = 'add'; }
        }
        syncScore(isCorrect, syncType, qKey);
      }
      showResult(isCorrect, currentQuestion.a);
    }

    function showResult(isCorrect, ans) {
      if(isCorrect) playCorrectSound(); else playWrongSound();
      const overlay = document.getElementById('result-overlay');
      overlay.classList.remove('hidden');
      document.getElementById('res-icon').innerText = isCorrect ? 'â­•' : 'âŒ';
      document.getElementById('res-text').innerText = isCorrect ? 'æ­£è§£ï¼' : 'æ®‹å¿µ...';
      document.getElementById('res-text').style.color = isCorrect ? '#28a745' : '#dc3545';
      document.getElementById('res-ans').innerText = ans;

      if (currentMode === 'hidden') {
        document.getElementById('link-container').classList.add('hidden');
        document.getElementById('exp-img-container').innerHTML = currentQuestion.expImg ? `<div style="margin-top:10px;"><img src="${currentQuestion.expImg}" onclick="openImageViewer('${currentQuestion.expImg}')" style="width:100%; max-height:280px; border-radius:8px; object-fit:contain; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor:pointer;"><div style="font-size:11px; color:#888; margin-top:5px;">ğŸ‘†ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æ‹¡å¤§ã—ã¾ã™</div></div>` : "";
      } else {
        document.getElementById('link-container').classList.remove('hidden');
        document.getElementById('exp-img-container').innerHTML = ""; 
        const searchQuery = currentQuestion.a + " " + currentQuestion.n; 
        document.getElementById('link-map').href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(searchQuery);
        document.getElementById('link-wiki').href = "https://ja.wikipedia.org/wiki/" + encodeURIComponent(currentQuestion.n);
      }
    }
  </script>
</body>
</html>
