<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="google" content="notranslate">
  <title>ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f8ff">
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">

  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; background-color: #f0f8ff; margin: 0; padding: 20px; color: #333; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
    .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; min-height: 500px; display: flex; flex-direction: column; position: relative; }
    input[type="text"], input[type="password"], select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white; -webkit-appearance: none; appearance: none; }
    
    .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; text-decoration: none; box-sizing: border-box; }
    .btn:active { transform: scale(0.98); }
    .btn-city { background: #00B900; }
    .btn-tour { background: #E67E22; }
    .btn-station { background: #17a2b8; } 
    .btn-review { background: #dc3545; }
    .btn-stats { background: #6f42c1; }
    .btn-giveup { background: #6c757d; margin-top: 5px; }
    .btn-dummy { background: #e0e0e0; color: #888; cursor: not-allowed; }
    .btn-choice { background: #f8f9fa; color: #333; border: 2px solid #007bff; }
    
    .hidden { display: none !important; }
    .stats-bar { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; }
    .stats-item span { font-size: 18px; font-weight: bold; color: #ffc107; margin-left: 5px; }
    
    .quiz-header { font-size: 14px; color: #666; margin-bottom: 5px; }
    .quiz-text { font-size: 24px; font-weight: bold; margin: 15px 0; min-height: 1.2em; line-height: 1.4; white-space: pre-wrap; }
    ruby { ruby-align: center; }
    rt { font-size: 10px; color: #666; font-weight: normal; }
    
    .quiz-img { max-height: 200px; width: auto; max-width: 100%; border-radius: 8px; object-fit: contain; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .result-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; overflow-y: auto; padding: 20px 0;}
    .res-icon { font-size: 80px; margin-bottom: 10px; }
    .res-text { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
    .correct-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 20px; width: 80%; }
    
    .news-box { text-align: left; background: #fff3cd; border: 1px solid #ffeeba; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; }
    .news-item { margin-bottom: 4px; color: #555; }
    .news-date { font-weight: bold; margin-right: 5px; color: #856404; }

    .settings-icon { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; z-index: 201; transition: transform 0.3s; }
    .settings-icon:active { transform: rotate(90deg); }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; position: relative; max-height: 90vh; overflow-y: auto;}
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .settings-list { list-style: none; padding: 0; margin: 0; text-align: left; }
    .settings-list li { padding: 15px 5px; border-bottom: 1px solid #eee; font-size: 16px; display: flex; align-items: center; cursor: pointer; }
    .settings-list li:last-child { border-bottom: none; }
    .settings-list li span.icon { margin-right: 10px; font-size: 20px; }
    
    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #00B900; }
    input:checked + .slider:before { transform: translateX(24px); }

    input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; padding: 0; border: none; background: #ccc; margin: 15px 0; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #007bff; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input[type=range]:disabled::-webkit-slider-thumb { background: #888; }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .stats-card { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #007bff; }
    .progress-bg { background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .progress-bar { height: 100%; width: 0%; transition: width 0.5s; }
    
    .help-section { text-align: left; margin-bottom: 15px; font-size: 14px; color: #444; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
    .help-section h4 { margin: 0 0 5px 0; color: #007bff; }
    
    .tab-container { display: flex; margin-bottom: 15px; border-bottom: 2px solid #eee; }
    .tab { flex: 1; padding: 10px; font-weight: bold; color: #888; cursor: pointer; }
    .tab.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -2px; }
  </style>
</head>
<body>

  <div id="iframe-modal" class="modal-overlay hidden" style="z-index: 100002; flex-direction: column;">
    <div style="width:100%; background:#fff; display:flex; justify-content:space-between; padding:10px; box-sizing:border-box;">
      <button class="btn" style="width:auto; margin:0; padding:8px 15px; background:#6c757d;" onclick="closeIframe()">é–‰ã˜ã‚‹</button>
      <div style="font-size:12px; color:#666; align-self:center;">â€»è¦‹ã‚Œãªã„å ´åˆã¯å³ã¸ğŸ‘‰</div>
      <button class="btn" style="width:auto; margin:0; padding:8px 15px; background:#007bff;" id="iframe-ext-btn">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
    </div>
    <iframe id="inapp-browser" style="width:100%; flex:1; border:none; background:#fff;"></iframe>
  </div>

  <div id="image-viewer" class="modal-overlay hidden" style="z-index: 100000; background: rgba(0,0,0,0.95); flex-direction: column;" onclick="closeImageViewer()">
    <div style="width: 100%; text-align: right; padding: 20px; box-sizing: border-box;"><span style="color: white; font-size: 30px; cursor: pointer; font-weight: bold;">âœ–</span></div>
    <img id="viewer-img" src="" style="max-width: 95%; max-height: 80%; object-fit: contain; border-radius: 8px;">
    <div style="color: white; margin-top: 15px; font-size: 14px;">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
  </div>

  <div id="custom-alert" class="modal-overlay hidden" style="z-index: 100001;">
    <div class="modal-content">
      <p id="alert-msg" style="font-size:16px; margin-bottom:20px; line-height:1.5;"></p>
      <button class="btn" onclick="closeAlert()" style="margin:0;">OK</button>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-size:18px; font-weight:bold;">æº–å‚™ä¸­...</div>
  </div>

  <div id="auth-modal" class="modal-overlay hidden" style="z-index: 99990;">
    <div class="modal-content" style="max-height: 85vh;">
      <h2 style="color:#00B900; margin-top:0;">ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</h2>
      
      <div style="text-align:left; font-size:13px; color:#555; margin-bottom:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
        <strong>ğŸ“– éŠã³æ–¹</strong><br>
        è¡¨ç¤ºã•ã‚ŒãŸç”»åƒã‚„ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ãã“ãŒã©ã®éƒ½é“åºœçœŒã«ã‚ã‚‹ã‹ã‚’å½“ã¦ã‚‹ã‚¯ã‚¤ã‚ºã§ã™ã€‚<br>
        é–“é•ãˆãŸå•é¡Œã¯è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã€ã€ŒğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã€ã§åŠ¹ç‡ã‚ˆãå­¦ç¿’ã§ãã¾ã™ï¼
      </div>

      <div class="tab-container">
        <div class="tab active" id="tab-register" onclick="switchAuthTab('register')">æ–°è¦ç™»éŒ²</div>
        <div class="tab" id="tab-login" onclick="switchAuthTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</div>
      </div>

      <div id="area-register">
        <p style="font-size:12px; color:#666; margin:0 0 10px 0;">ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã€ãŠå¥½ããªåå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
        <input type="text" id="reg-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <input type="password" id="reg-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn" style="background:#00B900; margin-top:15px;" onclick="registerAccount()">ã¯ã˜ã‚ã‚‹</button>
      </div>

      <div id="area-login" class="hidden">
        <p style="font-size:12px; color:#666; margin:0 0 10px 0;">ä»¥å‰ä½œæˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¼•ãç¶™ãã¾ã™ã€‚</p>
        <input type="text" id="login-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn" style="background:#007bff; margin-top:15px;" onclick="loginAccount()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content" style="padding:15px;">
      <h3 style="margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px;">âš™ï¸ è¨­å®š</h3>
      <ul class="settings-list">
        <li onclick="openSubModal('sound-modal')"><span class="icon">ğŸµ</span> ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</li>
        <li onclick="openSubModal('account-modal')"><span class="icon">ğŸ‘¤</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å¤‰æ›´</li>
        <li onclick="forceRefreshData()" style="color:#007bff;"><span class="icon">ğŸ”„</span> å…¨ãƒ‡ãƒ¼ã‚¿å†å–å¾— (ä¸å…·åˆæ™‚)</li>
        <li onclick="openSubModal('admin-modal')"><span class="icon">ğŸ”‘</span> ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</li>
        <li onclick="openSubModal('help-modal')"><span class="icon">ğŸ“–</span> ä½¿ã„æ–¹èª¬æ˜</li>
        <li onclick="logout()" style="color:#dc3545;"><span class="icon">ğŸšª</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
        <li onclick="openSubModal('delete-modal')" style="color:#dc3545;"><span class="icon">âš ï¸</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</li>
      </ul>
      <button class="btn" style="background:#6c757d; margin-bottom:0;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="sound-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸµ ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
      <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0;">
        <span style="font-weight:bold;">åŠ¹æœéŸ³</span>
        <label class="toggle-switch">
          <input type="checkbox" id="sound-toggle" onchange="toggleSound()">
          <span class="slider"></span>
        </label>
      </div>
      <div id="volume-container" style="margin-bottom: 30px; text-align:left;">
        <label style="font-weight:bold; display:flex; justify-content:space-between; margin-bottom:10px;">
          <span>éŸ³é‡</span>
          <span id="vol-display" style="color:#007bff; font-size:18px; font-weight:bold;">50</span>
        </label>
        <input type="range" id="sound-vol" min="0" max="100" step="1" value="50" oninput="changeVolume()" onchange="saveVolume()">
      </div>
      <button class="btn" style="background:#6c757d; margin:0;" onclick="closeSubModal('sound-modal')">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="account-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å¤‰æ›´</h3>
      <p style="font-size:12px; color:#666;">ç¾åœ¨ã®åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯æ›¸ãæ›ãˆã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
      <input type="text" id="edit-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
      <input type="password" id="edit-pass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('account-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#00B900; flex:1; margin:0;" onclick="updateAccount()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0; color:#dc3545;">âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</h3>
      <p style="font-size:13px; color:#333; line-height:1.5;">æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <input type="text" id="delete-confirm" placeholder="ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„" style="border-color:#dc3545;">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('delete-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#dc3545; flex:1; margin:0;" onclick="deleteAccount()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="help-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-height: 70vh;">
      <h3 style="margin-top:0;">ğŸ“– ä½¿ã„æ–¹èª¬æ˜</h3>
      <div class="help-section">
        <h4>ğŸ™ å¸‚ç”ºæ‘ / â›©ï¸ è¦³å…‰åœ° / ğŸš‰ é‰„é“é§…ã‚¯ã‚¤ã‚º</h4>
        è¡¨ç¤ºã•ã‚ŒãŸæƒ…å ±ã®å ´æ‰€ãŒã©ã®éƒ½é“åºœçœŒã«ã‚ã‚‹ã‹ã‚’å½“ã¦ã‚‹ã‚¯ã‚¤ã‚ºã§ã™ã€‚ä¸æ­£è§£ã ã£ãŸå•é¡Œã¯è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
      </div>
      <div class="help-section">
        <h4>ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</h4>
        ã“ã‚Œã¾ã§ã«é–“é•ãˆãŸå•é¡Œã ã‘ãŒãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã¾ã™ã€‚æ­£è§£ã™ã‚‹ã¨è‹¦æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
      </div>
      <button class="btn" style="background:#6c757d; margin:0; margin-top:15px;" onclick="closeSubModal('help-modal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="admin-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ”‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</h3>
      <p style="font-size:12px; color:#666;">ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="text" id="admin-pass-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom:20px; -webkit-text-security: disc;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeSubModal('admin-modal')">æˆ»ã‚‹</button>
        <button class="btn" style="background:#007bff; flex:1; margin:0;" onclick="checkAdmin()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="news-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ“¢ ãŠçŸ¥ã‚‰ã›ä¸€è¦§</h3>
      <div id="full-news-list" style="max-height: 60vh; overflow-y:auto; text-align:left; font-size:13px;"></div>
      <button class="btn" style="background:#6c757d; margin-top:15px;" onclick="closeNewsModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="startup-screen" class="card hidden">
    <h1 style="color:#00B900;">ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</h1>
    <p id="startup-msg" style="color:#dc3545; font-size:14px; margin-bottom:20px;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
    <button class="btn btn-city" onclick="window.location.reload();">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
    <hr style="margin:25px 0; border:0; border-top:1px dashed #ccc;">
    <button class="btn" style="background:#6c757d;" onclick="logout()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
  </div>

  <div id="menu-screen" class="card hidden">
    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
    <div class="stats-bar" id="menu-stats" style="margin-top:30px;"></div>
    
    <div id="news-box" class="news-box hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
        <button class="btn" style="padding:4px 8px; margin:0; width:auto; font-size:11px; background:#6c757d; border-radius:4px;" onclick="openNewsModal()">ãŠçŸ¥ã‚‰ã›ä¸€è¦§</button>
      </div>
      <div id="news-list"></div>
    </div>

    <button class="btn btn-city" onclick="startGame('city')">ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º</button>
    <button class="btn btn-tour" onclick="startGame('tourist')">â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º</button>
    <button class="btn btn-station" style="margin-top:10px;" onclick="startGame('station')">ğŸš‰ é‰„é“é§…ã‚¯ã‚¤ã‚º</button>
    <button class="btn btn-dummy" style="margin-top:10px;" onclick="myAlert('é›£èª­åœ°åã‚¯ã‚¤ã‚ºã¯è¿½åŠ äºˆå®šã§ã™ï¼')">ğŸ”’ è¿½åŠ äºˆå®šãƒ¢ãƒ¼ãƒ‰â‘ </button>
    <button class="btn btn-review" style="margin-top:10px;" onclick="startReview()">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="btn btn-stats" style="margin-top:10px;" onclick="showStatsDetail()">ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</button>
    
    <div style="text-align:center; margin-top:25px; font-size:11px; color:#aaa;">Ver <span id="app-version-display"></span></div>
  </div>

  <div id="stats-detail-screen" class="card hidden">
    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
    <h2 style="margin-top:0;">ğŸ“Š ãƒ—ãƒ¬ã‚¤ãƒ‡ãƒ¼ã‚¿</h2>
    <div id="stats-content"></div>
    <button class="btn" onclick="backToMenu()">æˆ»ã‚‹</button>
  </div>

  <div id="game-screen" class="card hidden">
    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
    <div class="stats-bar" id="game-stats" style="margin-top:30px;">
      <div class="stats-item">æ­£è§£æ•°: <span id="st-correct">0</span></div>
      <div class="stats-item">æ­£è§£ç‡: <span id="st-rate">0%</span></div>
    </div>
    
    <div id="review-banner" class="hidden" style="background:#dc3545; color:white; font-size:12px; padding:2px; margin-bottom:5px; border-radius:4px;">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­</div>

    <div id="quiz-area">
      <div class="quiz-header" id="q-header">ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ</div>
      <div id="q-img-container"></div>
      <div class="quiz-text" id="q-text"></div>
    </div>
    
    <div style="margin-top: auto;">
      <div id="normal-answer-area">
        <select id="answer-select"><option value="" disabled selected>éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        <button class="btn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
        <button class="btn btn-giveup" onclick="giveUp()">ğŸ³ï¸ åˆ†ã‹ã‚‰ãªã„</button>
      </div>

      <div id="hidden-answer-area" class="hidden">
        <button class="btn btn-choice" id="btn-choice-0" onclick="submitHiddenAnswer(0)"></button>
        <button class="btn btn-choice" id="btn-choice-1" onclick="submitHiddenAnswer(1)"></button>
        <button class="btn btn-choice" id="btn-choice-2" onclick="submitHiddenAnswer(2)"></button>
        <button class="btn btn-choice" id="btn-choice-3" onclick="submitHiddenAnswer(3)"></button>
      </div>

      <div style="text-align:center; margin-top:15px;"><button class="btn" style="background:transparent; color:#999; border:none; width:auto; display:inline-block; font-size:12px; padding:5px;" onclick="backToMenu()">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button></div>
    </div>

    <div id="result-overlay" class="result-overlay hidden">
      <div class="res-icon" id="res-icon"></div>
      <div class="res-text" id="res-text"></div>
      <div class="correct-box">
        <span style="font-size:12px; color:#666;">æ­£è§£ã¯...</span><br>
        <span id="res-ans" style="font-size:28px; font-weight:bold; color:#007bff; display:block; margin-bottom:10px;"></span>
        <div id="exp-img-container"></div>
      </div>
      
      <div id="link-container" style="display:flex; gap:10px; width:90%; margin-bottom: 20px;">
        <a id="link-map" class="btn" style="background:#4285F4; flex:1; margin:0; padding:10px 0; font-size:14px; line-height:1.2;">ğŸ—ºï¸ GoogleMap<br><span style="font-size:10px;">(åˆ¥ã‚¿ãƒ–ã§é–‹ã)</span></a>
        <a id="link-wiki" class="btn" style="background:#333; flex:1; margin:0; padding:10px 0; font-size:14px; line-height:1.2;">ğŸ“– Wikipedia<br><span style="font-size:10px;">(ã‚¢ãƒ—ãƒªå†…ã§é–‹ã)</span></a>
      </div>

      <button class="btn btn-next" style="width:90%;" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â¡</button>
    </div>
  </div>

  <script>
    const HTML_VERSION = "2.7.4"; 
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(reg => { reg.update(); });
    }

    const savedHtmlVersion = localStorage.getItem('quiz_html_version');
    if (savedHtmlVersion !== HTML_VERSION) {
      if ('caches' in window) { caches.keys().then(names => { names.forEach(name => caches.delete(name)); }); }
      localStorage.setItem('quiz_html_version', HTML_VERSION);
      localStorage.removeItem('quiz_app_masterdata'); 
      localStorage.removeItem('quiz_app_master_ver');
      window.location.reload(true);
    }

    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzv0Gz2d0Ex0NDW8MHuHX6tCKqtGGsUfXrqhQFnar0F0Xw9y5RaFDKz13JZQTh_x2Nk/exec";
    
    let appData = { stats: null, city: [], tourist: [], station: [], news: [], hidden: [] };
    let currentMode = null; let currentQuestion = null; let wrongList = null; 
    let currentChoices = []; let hiddenQueue = []; 

    const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

    let audioCtx;
    let soundEnabled = (localStorage.getItem('quiz_app_sound') !== 'false');
    let soundVol = parseInt(localStorage.getItem('quiz_app_vol')) || 50;

    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    document.addEventListener('touchstart', initAudio, { once: true });
    document.addEventListener('click', initAudio, { once: true });

    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn') || e.target.closest('.settings-list li') || e.target.closest('.settings-icon') || e.target.closest('.news-item')) {
        playTone(600, 'sine', 0.05, 0.3);
      }
    });

    function playTone(freq, type, duration, volScale) {
      if (!soundEnabled || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      const actualVol = (soundVol / 100) * volScale * 3.0;
      gain.gain.setValueAtTime(actualVol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function playCorrectSound() { playTone(987, 'sine', 0.15, 0.4); setTimeout(() => playTone(784, 'sine', 0.4, 0.4), 150); }
    function playWrongSound() { playTone(150, 'square', 0.4, 0.15); playTone(156, 'square', 0.4, 0.15); }

    function updateSliderColor() {
      const slider = document.getElementById('sound-vol');
      if (!soundEnabled) { slider.style.background = '#ccc'; return; }
      const val = slider.value;
      slider.style.background = `linear-gradient(to right, #007bff ${val}%, #ccc ${val}%)`;
    }

    function updateVolUI() {
      const volContainer = document.getElementById('volume-container');
      const volSlider = document.getElementById('sound-vol');
      const volDisplay = document.getElementById('vol-display');
      if (soundEnabled) {
        volContainer.style.opacity = "1"; volContainer.style.pointerEvents = "auto";
        volSlider.disabled = false; volDisplay.innerText = soundVol; volDisplay.style.color = "#007bff";
      } else {
        volContainer.style.opacity = "0.4"; volContainer.style.pointerEvents = "none";
        volSlider.disabled = true; volDisplay.innerText = "OFF"; volDisplay.style.color = "#888";
      }
      updateSliderColor();
    }
    function toggleSound() {
      soundEnabled = document.getElementById('sound-toggle').checked;
      localStorage.setItem('quiz_app_sound', soundEnabled);
      updateVolUI();
      if(soundEnabled) { initAudio(); playTone(880, 'sine', 0.1, 0.3); }
    }
    function changeVolume() {
      soundVol = document.getElementById('sound-vol').value;
      document.getElementById('vol-display').innerText = soundVol;
      updateSliderColor();
    }
    function saveVolume() {
      localStorage.setItem('quiz_app_vol', soundVol);
      playTone(600, 'sine', 0.1, 0.3);
    }

    window.onload = function() {
      document.getElementById('app-version-display').innerText = HTML_VERSION;

      const select = document.getElementById('answer-select');
      prefectures.forEach(pref => {
        const option = document.createElement('option'); option.value = pref; option.textContent = pref; select.appendChild(option);
      });
      
      document.getElementById('sound-toggle').checked = soundEnabled;
      document.getElementById('sound-vol').value = soundVol;
      updateVolUI();

      const storedName = localStorage.getItem('quiz_app_name');
      const storedPass = localStorage.getItem('quiz_app_pass');
      
      if (storedName && storedPass) {
        performLogin(storedName, storedPass);
      } else {
        document.getElementById('menu-screen').classList.remove('hidden');
        document.getElementById('loading-overlay').classList.add('hidden');
        document.getElementById('auth-modal').classList.remove('hidden');
      }
    };

    function switchAuthTab(tab) {
      if(tab === 'register') {
        document.getElementById('tab-register').classList.add('active'); document.getElementById('tab-login').classList.remove('active');
        document.getElementById('area-register').classList.remove('hidden'); document.getElementById('area-login').classList.add('hidden');
      } else {
        document.getElementById('tab-login').classList.add('active'); document.getElementById('tab-register').classList.remove('active');
        document.getElementById('area-login').classList.remove('hidden'); document.getElementById('area-register').classList.add('hidden');
      }
    }

    function myAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('custom-alert').classList.remove('hidden'); }
    function closeAlert() { document.getElementById('custom-alert').classList.add('hidden'); }
    function openImageViewer(src) { document.getElementById('viewer-img').src = src; document.getElementById('image-viewer').classList.remove('hidden'); }
    function closeImageViewer() { document.getElementById('image-viewer').classList.add('hidden'); document.getElementById('viewer-img').src = ""; }
    
    function openIframe(url) {
      document.getElementById('inapp-browser').src = url;
      document.getElementById('iframe-ext-btn').onclick = () => window.open(url, '_blank');
      document.getElementById('iframe-modal').classList.remove('hidden');
    }
    function closeIframe() {
      document.getElementById('iframe-modal').classList.add('hidden');
      document.getElementById('inapp-browser').src = "";
    }

    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    function openSubModal(id) {
      closeSettings(); document.getElementById(id).classList.remove('hidden');
      if(id === 'account-modal') {
        document.getElementById('edit-name').value = localStorage.getItem('quiz_app_name') || "";
        document.getElementById('edit-pass').value = localStorage.getItem('quiz_app_pass') || "";
      }
      if(id === 'admin-modal') { document.getElementById('admin-pass-input').value = ""; }
    }
    function closeSubModal(id) { document.getElementById(id).classList.add('hidden'); openSettings(); }
    function openNewsModal() { document.getElementById('news-modal').classList.remove('hidden'); }
    function closeNewsModal() { document.getElementById('news-modal').classList.add('hidden'); }

    function clearLoginData() { localStorage.removeItem('quiz_app_name'); localStorage.removeItem('quiz_app_pass'); }

    function showStartupError(msg) {
      hideLoading(); hideAll();
      document.getElementById('startup-msg').innerHTML = msg;
      document.getElementById('startup-screen').classList.remove('hidden');
    }

    function forceRefreshData() {
      closeSettings();
      if(confirm("ã‚¹ãƒãƒ›å†…ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã™ã¹ã¦æ¶ˆå»ã—ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ç›´ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆæˆç¸¾ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) {
        localStorage.removeItem('quiz_app_masterdata'); 
        localStorage.removeItem('quiz_app_master_ver');
        sessionStorage.removeItem('activeScreen'); // ç”»é¢çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        window.location.reload(true);
      }
    }

    function getFetchUrl(baseQuery) {
      let url = `${GAS_API_URL}?${baseQuery}`;
      const localMaster = localStorage.getItem('quiz_app_masterdata');
      const localMasterVer = localStorage.getItem('quiz_app_master_ver');
      if (localMaster && localMasterVer === HTML_VERSION) {
        url += "&needMaster=false";
        const parsed = JSON.parse(localMaster);
        appData.city = parsed.city;
        appData.tourist = parsed.tourist;
        appData.station = parsed.station || []; 
      } else {
        url += "&needMaster=true";
      }
      return url;
    }

    async function registerAccount() {
      const name = document.getElementById('reg-name').value;
      const pass = document.getElementById('reg-pass').value;
      if(!name || !pass) return myAlert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆä¸­...");
      try {
        const url = getFetchUrl(`action=register&name=${encodeURIComponent(name)}&pass=${encodeURIComponent(pass)}`);
        const res = await fetch(url).then(r => r.json());
        if(res.success) { document.getElementById('auth-modal').classList.add('hidden'); onDataLoaded(res); } 
        else { hideLoading(); myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function loginAccount() {
      const name = document.getElementById('login-name').value;
      const pass = document.getElementById('login-pass').value;
      if(!name || !pass) return myAlert("å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("ãƒ­ã‚°ã‚¤ãƒ³ä¸­...");
      try {
        const url = getFetchUrl(`action=login&name=${encodeURIComponent(name)}&pass=${encodeURIComponent(pass)}`);
        const res = await fetch(url).then(r => r.json());
        if(res.success) { document.getElementById('auth-modal').classList.add('hidden'); onDataLoaded(res); } 
        else { hideLoading(); myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function performLogin(name, pass) {
      try {
        const url = getFetchUrl(`action=login&name=${encodeURIComponent(name)}&pass=${encodeURIComponent(pass)}`);
        const res = await fetch(url).then(r => r.json());
        if (res.success) { onDataLoaded(res); } 
        else { clearLoginData(); showStartupError("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æƒ…å ±ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚"); }
      } catch(e) { showStartupError("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); }
    }

    async function updateAccount() {
      const oldName = localStorage.getItem('quiz_app_name');
      const newName = document.getElementById('edit-name').value;
      const newPass = document.getElementById('edit-pass').value;
      if (!newName || !newPass) return myAlert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      showLoading("æ›´æ–°ä¸­...");
      try {
        const res = await fetch(`${GAS_API_URL}?action=updateAccount&oldName=${encodeURIComponent(oldName)}&newName=${encodeURIComponent(newName)}&newPass=${encodeURIComponent(newPass)}`).then(r => r.json());
        hideLoading();
        if (res.success) {
          localStorage.setItem('quiz_app_name', newName); localStorage.setItem('quiz_app_pass', newPass);
          myAlert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼"); closeSubModal('account-modal');
        } else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function deleteAccount() {
      const confirmText = document.getElementById('delete-confirm').value;
      if (confirmText !== "å‰Šé™¤") return myAlert("ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„");
      showLoading("å‰Šé™¤ä¸­...");
      try {
        const name = localStorage.getItem('quiz_app_name');
        const res = await fetch(`${GAS_API_URL}?action=deleteAccount&name=${encodeURIComponent(name)}`).then(r => r.json());
        hideLoading();
        if (res.success) { alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚"); logout(); } 
        else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    async function checkAdmin() {
      const pass = document.getElementById('admin-pass-input').value;
      if (!pass) return myAlert("ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      document.getElementById('admin-modal').classList.add('hidden'); showLoading("èªè¨¼ä¸­...");
      try {
        const res = await fetch(`${GAS_API_URL}?action=checkAdmin&pass=${encodeURIComponent(pass)}`).then(r => r.json());
        hideLoading(); 
        if (res.success) { appData.hidden = res.hiddenQuiz; startHiddenQuiz(); } 
        else { myAlert(res.message); }
      } catch(e) { hideLoading(); myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
    }

    function onDataLoaded(res) {
      hideLoading();
      if (!res.success) return showStartupError(res.message || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");

      localStorage.setItem('quiz_app_name', res.name); 
      localStorage.setItem('quiz_app_pass', res.pass);

      const currentVersion = localStorage.getItem('quiz_app_version') || "1.0";
      if (res.appVersion && parseFloat(res.appVersion) > parseFloat(currentVersion)) {
        localStorage.setItem('quiz_app_version', res.appVersion); 
        localStorage.removeItem('quiz_app_masterdata');
        localStorage.removeItem('quiz_app_master_ver');
        sessionStorage.removeItem('activeScreen');
        myAlert("ğŸš€ ã‚¢ãƒ—ãƒªã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™ã€‚");
        setTimeout(() => { window.location.reload(); }, 2000); return;
      }
      
      if (res.masterData) {
        appData.city = res.masterData.city;
        appData.tourist = res.masterData.tourist;
        appData.station = res.masterData.station || []; 
        localStorage.setItem('quiz_app_masterdata', JSON.stringify(res.masterData));
        localStorage.setItem('quiz_app_master_ver', HTML_VERSION);
      }
      
      appData.stats = res.stats; 
      appData.news = res.news || []; 
      wrongList = null;
      document.getElementById('loading-overlay').classList.add('hidden'); 
      
      const activeScreen = sessionStorage.getItem('activeScreen') || 'menu';
      const activeMode = sessionStorage.getItem('activeMode');

      if (activeScreen === 'game' && activeMode) {
        if (activeMode === 'review') {
          startReview();
        } else if (activeMode === 'hidden') {
          showMenu(); 
        } else {
          startGame(activeMode);
        }
      } else if (activeScreen === 'stats') {
        showStatsDetail();
      } else {
        showMenu();
      }
    }

    function showMenu() {
      sessionStorage.setItem('activeScreen', 'menu'); 
      hideAll(); document.getElementById('menu-screen').classList.remove('hidden');
      
      if (!appData.stats || !appData.stats.total) {
        appData.stats = { total: {correct:0, total:0, rate:0}, city: {correct:0, total:0, rate:0}, tourist: {correct:0, total:0, rate:0}, station: {correct:0, total:0, rate:0} };
      }
      
      document.getElementById('menu-stats').innerHTML = `<div class="stats-item">æ­£è§£æ•°: <span>${appData.stats.total.correct}</span></div><div class="stats-item">æ­£è§£ç‡: <span>${appData.stats.total.rate}%</span></div>`;
      
      if (appData.news && appData.news.length > 0) {
        document.getElementById('news-box').classList.remove('hidden');
        let topHtml = ''; let fullHtml = '';
        appData.news.forEach((n, i) => { 
          let detHtml = n.details ? `<div id="news-det-top-${i}" class="hidden" style="margin-top:8px; padding-top:8px; border-top:1px dashed #ccc; color:#444; line-height:1.4;">${n.details.replace(/\n/g, '<br>')}</div>` : '';
          let detHtmlModal = n.details ? `<div id="news-det-mod-${i}" class="hidden" style="margin-top:8px; padding-top:8px; border-top:1px dashed #ccc; color:#444; line-height:1.4;">${n.details.replace(/\n/g, '<br>')}</div>` : '';
          
          if(i < 3) topHtml += `<div class="news-item" style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; cursor:pointer;" onclick="document.getElementById('news-det-top-${i}').classList.toggle('hidden')"><span class="news-date" style="display:block; margin-bottom:3px;">${n.date}</span><span style="font-weight:bold; color:#007bff;">${n.title}</span>${detHtml}</div>`; 
          fullHtml += `<div class="news-item" style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; cursor:pointer;" onclick="document.getElementById('news-det-mod-${i}').classList.toggle('hidden')"><span class="news-date" style="display:block; margin-bottom:3px;">${n.date}</span><span style="font-weight:bold; color:#007bff;">${n.title}</span>${detHtmlModal}</div>`;
        });
        document.getElementById('news-list').innerHTML = topHtml; document.getElementById('full-news-list').innerHTML = fullHtml;
      } else { document.getElementById('news-box').classList.add('hidden'); }
    }

    async function startReview() {
      sessionStorage.setItem('activeScreen', 'game'); 
      sessionStorage.setItem('activeMode', 'review'); 
      if (wrongList === null) {
        showLoading("å¾©ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
        try {
          const name = localStorage.getItem('quiz_app_name');
          const res = await fetch(`${GAS_API_URL}?action=getWrongList&name=${encodeURIComponent(name)}`).then(r => r.json());
          if (res.wrongList) wrongList = res.wrongList; else throw new Error();
          hideLoading();
        } catch(e) { hideLoading(); return myAlert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
      }
      if (wrongList.length === 0) return myAlert("å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼å„ªç§€ï¼");
      currentMode = 'review'; document.getElementById('review-banner').classList.remove('hidden');
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden');
    }

    function startHiddenQuiz() {
      sessionStorage.setItem('activeScreen', 'game'); 
      sessionStorage.setItem('activeMode', 'hidden'); 
      currentMode = 'hidden'; document.getElementById('review-banner').classList.add('hidden');
      hiddenQueue = [...appData.hidden]; hiddenQueue.sort(() => Math.random() - 0.5);
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden'); 
    }

    async function syncScore(isCorrect, syncType, wrongId) {
      if (currentMode === 'hidden') return; 
      try {
        const name = localStorage.getItem('quiz_app_name');
        const res = await fetch(`${GAS_API_URL}?action=sync&name=${encodeURIComponent(name)}&mode=${currentMode}&isCorrect=${isCorrect}&syncType=${syncType}&wrongId=${encodeURIComponent(wrongId)}`).then(r => r.json());
        if(res && res.success) appData.stats = res.stats;
      } catch(e) {}
    }
    
    function hideAll() { ['startup-screen','menu-screen','game-screen','stats-detail-screen'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
    function showLoading(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    
    function showStatsDetail() {
      sessionStorage.setItem('activeScreen', 'stats'); 
      if (!appData.stats || !appData.stats.total) {
        appData.stats = { total: {correct:0, total:0, rate:0}, city: {correct:0, total:0, rate:0}, tourist: {correct:0, total:0, rate:0}, station: {correct:0, total:0, rate:0} };
      }
      hideAll(); document.getElementById('stats-detail-screen').classList.remove('hidden');
      document.getElementById('stats-content').innerHTML = `${createStatsCard("ç·åˆãƒ‡ãƒ¼ã‚¿", appData.stats.total, "#007bff")}${createStatsCard("ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º", appData.stats.city, "#28a745")}${createStatsCard("â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º", appData.stats.tourist, "#e67e22")}${createStatsCard("ğŸš‰ é‰„é“é§…ã‚¯ã‚¤ã‚º", appData.stats.station, "#17a2b8")}`;
    }

    function createStatsCard(title, obj, color) {
      if(!obj) obj = {total:0, correct:0, rate:0};
      let rateVal = (obj.total > 0) ? ((obj.correct / obj.total) * 100) : 0;
      return `<div class="stats-card" style="border-left-color: ${color}"><h3>${title}</h3><div class="stats-row"><span>å›ç­”æ•°</span><span class="stats-val">${obj.total} å•</span></div><div class="stats-row"><span>æ­£è§£æ•°</span><span class="stats-val">${obj.correct} å•</span></div><div class="progress-bg"><div class="progress-bar" style="width:${rateVal}%; background:${color};"></div></div><div style="text-align:right; font-size:12px; margin-top:2px;">æ­£è§£ç‡: ${obj.rate}%</div></div>`;
    }

    function startGame(mode) {
      sessionStorage.setItem('activeScreen', 'game'); 
      sessionStorage.setItem('activeMode', mode);     
      currentMode = mode;
      
      let dataset;
      if(mode === 'city') dataset = appData.city;
      else if(mode === 'tourist') dataset = appData.tourist;
      else if(mode === 'station') dataset = appData.station;

      if (!dataset || dataset.length === 0) {
        sessionStorage.setItem('activeScreen', 'menu'); 
        return myAlert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰ã€Œå…¨ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚");
      }
      document.getElementById('review-banner').classList.add('hidden');
      nextQuestion(); hideAll(); document.getElementById('game-screen').classList.remove('hidden');
    }
    
    function backToMenu() { showMenu(); }
    function logout() { clearLoginData(); location.reload(); }

    function nextQuestion() {
      document.getElementById('result-overlay').classList.add('hidden');
      if (currentMode === 'hidden') {
        document.getElementById('normal-answer-area').classList.add('hidden'); document.getElementById('hidden-answer-area').classList.remove('hidden');
        document.getElementById('q-header').innerText = "ãŠ™ï¸ éš ã—ã‚¯ã‚¤ã‚º ãŠ™ï¸"; document.getElementById('st-correct').innerText = "ãŠ™ï¸"; document.getElementById('st-rate').innerText = "éš ã‚Œ";
        if (hiddenQueue.length === 0) {
          document.getElementById('q-text').innerText = "ã™ã¹ã¦ã®éš ã—ã‚¯ã‚¤ã‚ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ğŸ‰\nã‚‚ã†å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          document.getElementById('q-img-container').innerHTML = ""; document.getElementById('hidden-answer-area').classList.add('hidden'); return;
        }
        currentQuestion = hiddenQueue.pop();
        currentChoices = [currentQuestion.a, currentQuestion.w1, currentQuestion.w2, currentQuestion.w3].sort(() => Math.random() - 0.5); 
        for (let i = 0; i < 4; i++) { document.getElementById('btn-choice-' + i).innerText = currentChoices[i]; }
      } else {
        document.getElementById('normal-answer-area').classList.remove('hidden'); document.getElementById('hidden-answer-area').classList.add('hidden');
        document.getElementById('q-header').innerText = "ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ";
        
        if (currentMode === 'review') {
          if (!wrongList || wrongList.length === 0) { myAlert("å¾©ç¿’å®Œäº†ï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚"); return backToMenu(); }
          const randKey = wrongList[Math.floor(Math.random() * wrongList.length)];
          currentQuestion = appData.city.find(item => (item.q + "_" + item.a) === randKey) || appData.tourist.find(item => (item.q + "_" + item.a) === randKey) || appData.station.find(item => (item.q + "_" + item.a) === randKey);
          
          if (!currentQuestion) { wrongList = wrongList.filter(k => k !== randKey); return nextQuestion(); }
          document.getElementById('st-correct').innerText = "-"; document.getElementById('st-rate').innerText = "å¾©ç¿’";
        } else {
          let dataset;
          if(currentMode === 'city') dataset = appData.city;
          else if(currentMode === 'tourist') dataset = appData.tourist;
          else if(currentMode === 'station') dataset = appData.station;

          currentQuestion = dataset[Math.floor(Math.random() * dataset.length)];
          
          if (!appData.stats || !appData.stats[currentMode]) {
             appData.stats = { total: {correct:0, total:0, rate:0}, city: {correct:0, total:0, rate:0}, tourist: {correct:0, total:0, rate:0}, station: {correct:0, total:0, rate:0} };
          }
          const s = appData.stats[currentMode];
          document.getElementById('st-correct').innerText = s.correct + '/' + s.total; document.getElementById('st-rate').innerText = s.rate + '%';
        }
      }
      document.getElementById('answer-select').selectedIndex = 0;
      
      if (currentMode === 'station' || (currentMode === 'review' && currentQuestion.mode === 'station')) {
        document.getElementById('q-text').innerHTML = `
          <div style="font-size:14px; color:#666; background:#e9ecef; padding:4px 10px; border-radius:15px; display:inline-block; margin-bottom:10px;">ğŸ›¤ï¸ ${currentQuestion.line}</div>
          <div style="font-size:34px; color:#17a2b8; font-weight:bold; margin-bottom:5px;">${currentQuestion.q}</div>
        `;
      } else {
        let qHtml = currentQuestion.q;
        if (currentQuestion.q_kana) qHtml = `<ruby>${currentQuestion.q}<rt>${currentQuestion.q_kana}</rt></ruby>`;
        document.getElementById('q-text').innerHTML = qHtml;
      }
      
      document.getElementById('q-img-container').innerHTML = currentQuestion.i ? `<img src="${currentQuestion.i}" class="quiz-img">` : '';
    }

    function submitAnswer() {
      const v = document.getElementById('answer-select').value;
      if(!v) return myAlert("éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„"); processAnswer(v);
    }
    function giveUp() { processAnswer("GIVE_UP"); }
    function submitHiddenAnswer(index) { processAnswer(currentChoices[index]); }

    function processAnswer(ans) {
      let validAnswers = [];
      let isCorrect = false;
      let qKey = "";

      if (currentMode === 'city' || (currentMode === 'review' && currentQuestion.mode === 'city')) {
        const matchingRows = appData.city.filter(item => item.q === currentQuestion.q);
        validAnswers = matchingRows.map(item => item.a);
        isCorrect = validAnswers.includes(ans);
      } else if (currentMode !== 'hidden') {
        validAnswers = [currentQuestion.a];
        isCorrect = (ans === currentQuestion.a);
      } else {
        isCorrect = (ans === currentQuestion.a);
      }

      let syncType = 'none';
      if (currentMode !== 'hidden') {
        qKey = currentQuestion.q + "_" + currentQuestion.a; 
        if (currentMode === 'review') {
          if (isCorrect) { wrongList = wrongList.filter(k => k !== qKey); syncType = 'remove'; }
        } else {
          const s = appData.stats[currentMode]; 
          s.total++; if(isCorrect) s.correct++; 
          s.rate = (s.total > 0) ? ((s.correct / s.total) * 100).toFixed(1) : 0;
          
          const t = appData.stats.total; 
          t.total++; if(isCorrect) t.correct++; 
          t.rate = (t.total > 0) ? ((t.correct / t.total) * 100).toFixed(1) : 0;
          
          if (!isCorrect) { if (wrongList && !wrongList.includes(qKey)) wrongList.push(qKey); syncType = 'add'; }
        }
        syncScore(isCorrect, syncType, qKey);
      }
      showResult(isCorrect, ans, validAnswers);
    }

    // â˜…ä¿®æ­£ï¼šGoogle Mapã®ãƒªãƒ³ã‚¯URLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Œå…¨ä¿®æ­£
    function showResult(isCorrect, ans, validAnswers) {
      if(isCorrect) playCorrectSound(); else playWrongSound();
      const overlay = document.getElementById('result-overlay');
      overlay.classList.remove('hidden');
      document.getElementById('res-icon').innerText = isCorrect ? 'â­•' : 'âŒ';
      document.getElementById('res-text').innerText = isCorrect ? 'æ­£è§£ï¼' : 'æ®‹å¿µ...';
      document.getElementById('res-text').style.color = isCorrect ? '#28a745' : '#dc3545';

      let correctDisplayHtml = "";
      if (currentMode === 'city' || (currentMode === 'review' && currentQuestion.mode === 'city')) {
        const matchingRows = appData.city.filter(item => item.q === currentQuestion.q);
        correctDisplayHtml = matchingRows.map(item => item.a_kana ? `<ruby>${item.a}<rt>${item.a_kana}</rt></ruby>` : item.a).join(' / ');
      } else {
        correctDisplayHtml = currentQuestion.q_kana ? `<ruby>${currentQuestion.a}<rt>${currentQuestion.q_kana}</rt></ruby>` : currentQuestion.a;
      }
      document.getElementById('res-ans').innerHTML = correctDisplayHtml;

      if (currentMode === 'hidden') {
        document.getElementById('link-container').classList.add('hidden');
        document.getElementById('exp-img-container').innerHTML = currentQuestion.expImg ? `<div style="margin-top:10px;"><img src="${currentQuestion.expImg}" onclick="openImageViewer('${currentQuestion.expImg}')" style="width:100%; max-height:280px; border-radius:8px; object-fit:contain; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor:pointer;"><div style="font-size:11px; color:#888; margin-top:5px;">ğŸ‘†ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æ‹¡å¤§ã—ã¾ã™</div></div>` : "";
      } else {
        document.getElementById('link-container').classList.remove('hidden');
        document.getElementById('exp-img-container').innerHTML = ""; 
        
        let mapUrl, wikiUrl;
        
        // â˜…ä¿®æ­£ï¼šæ¤œç´¢ãƒ»åº§æ¨™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¬å¼ã®æ­£ã—ã„å½¢å¼ã«ç›´ã—ã¾ã—ãŸ
        if (currentMode === 'city' || (currentMode === 'review' && currentQuestion.mode === 'city')) {
          mapUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(currentQuestion.a + " " + currentQuestion.q);
          wikiUrl = currentQuestion.wiki || ("https://ja.wikipedia.org/wiki/" + encodeURIComponent(currentQuestion.q));
        } else if (currentMode === 'station' || (currentMode === 'review' && currentQuestion.mode === 'station')) {
          mapUrl = "https://www.google.com/maps/search/?api=1&query=" + currentQuestion.lat + "," + currentQuestion.lng;
          wikiUrl = "https://ja.wikipedia.org/wiki/" + encodeURIComponent(currentQuestion.q);
        } else {
          mapUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(currentQuestion.a + " " + currentQuestion.q);
          wikiUrl = "https://ja.wikipedia.org/wiki/" + encodeURIComponent(currentQuestion.q);
        }
        
        document.getElementById('link-map').onclick = () => window.open(mapUrl, '_blank');
        document.getElementById('link-wiki').onclick = () => openIframe(wikiUrl);
      }
    }
  </script>
</body>
</html>
