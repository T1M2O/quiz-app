<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f8ff">
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5fe.png">

  <style>
    /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; background-color: #f0f8ff; margin: 0; padding: 20px; color: #333; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
    .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; min-height: 500px; display: flex; flex-direction: column; position: relative; }
    input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white; -webkit-appearance: none; appearance: none; }
    
    .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; text-decoration: none; box-sizing: border-box; }
    .btn:active { transform: scale(0.98); }
    .btn-city { background: #00B900; }
    .btn-tour { background: #E67E22; }
    .btn-review { background: #dc3545; }
    .btn-stats { background: #6f42c1; }
    .btn-giveup { background: #6c757d; margin-top: 5px; }
    .btn-dummy { background: #e0e0e0; color: #888; cursor: not-allowed; }
    .btn-choice { background: #f8f9fa; color: #333; border: 2px solid #007bff; }
    
    .hidden { display: none !important; }
    .stats-bar { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; }
    .stats-item span { font-size: 18px; font-weight: bold; color: #ffc107; margin-left: 5px; }
    
    /* ã‚¯ã‚¤ã‚ºç”»é¢ */
    .quiz-header { font-size: 14px; color: #666; margin-bottom: 5px; }
    .quiz-text { font-size: 24px; font-weight: bold; margin: 15px 0; min-height: 1.2em; line-height: 1.4; }
    .quiz-img { max-height: 200px; width: auto; max-width: 100%; border-radius: 8px; object-fit: contain; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    /* çµæœç”»é¢ */
    .result-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
    .res-icon { font-size: 80px; margin-bottom: 10px; }
    .res-text { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
    .correct-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 20px; width: 80%; }
    
    /* ãŠçŸ¥ã‚‰ã›æ¬„ */
    .news-box { text-align: left; background: #fff3cd; border: 1px solid #ffeeba; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; max-height: 100px; overflow-y: auto; }
    .news-box h3 { margin: 0 0 5px 0; font-size: 14px; color: #856404; }
    .news-item { margin-bottom: 4px; color: #555; }
    .news-date { font-weight: bold; margin-right: 5px; color: #856404; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç³» */
    .settings-icon { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; z-index: 100; transition: transform 0.3s; }
    .settings-icon:active { transform: rotate(90deg); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .settings-list { list-style: none; padding: 0; margin: 0; text-align: left; }
    .settings-list li { padding: 15px 5px; border-bottom: 1px solid #eee; font-size: 16px; display: flex; align-items: center; cursor: pointer; }
    .settings-list li:last-child { border-bottom: none; }
    .settings-list li span.icon { margin-right: 10px; font-size: 20px; }
    .disabled-item { color: #aaa; cursor: not-allowed; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .stats-card { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #007bff; }
    .progress-bg { background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .progress-bar { height: 100%; width: 0%; transition: width 0.5s; }
  </style>
</head>
<body>

  <div id="custom-alert" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="alert-msg" style="font-size:16px; margin-bottom:20px; line-height:1.5;"></p>
      <button class="btn" onclick="closeAlert()" style="margin:0;">OK</button>
    </div>
  </div>

  <div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content" style="padding:15px;">
      <h3 style="margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px;">âš™ï¸ è¨­å®š</h3>
      <ul class="settings-list">
        <li class="disabled-item" onclick="myAlert('ç¾åœ¨æº–å‚™ä¸­ã§ã™')"><span class="icon">ğŸµ</span> ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</li>
        <li class="disabled-item" onclick="myAlert('ç¾åœ¨æº–å‚™ä¸­ã§ã™')"><span class="icon">ğŸ‘¤</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å¤‰æ›´</li>
        <li onclick="openAdmin()"><span class="icon">ğŸ”‘</span> ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</li>
        <li class="disabled-item" onclick="myAlert('ç¾åœ¨æº–å‚™ä¸­ã§ã™')"><span class="icon">ğŸ“–</span> ä½¿ã„æ–¹èª¬æ˜</li>
        <li onclick="logout()" style="color:#dc3545;"><span class="icon">ğŸšª</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
        <li class="disabled-item" onclick="myAlert('ç¾åœ¨æº–å‚™ä¸­ã§ã™')"><span class="icon">âš ï¸</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</li>
      </ul>
      <button class="btn" style="background:#6c757d; margin-bottom:0;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="admin-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ”‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</h3>
      <p style="font-size:12px; color:#666;">ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="text" id="admin-pass-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom:20px;">
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#6c757d; flex:1; margin:0;" onclick="closeAdmin()">æˆ»ã‚‹</button>
        <button class="btn" style="background:#007bff; flex:1; margin:0;" onclick="checkAdmin()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div id="loading-text" style="font-size:18px; font-weight:bold;">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div id="login-screen" class="card">
    <h1 style="color:#00B900;">ã‚¸ã‚ªã‚²å¯¾ç­–ã‚¯ã‚¤ã‚º</h1>
    <p>ç™»éŒ²ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</p>
    <input type="text" id="login-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
    <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" onclick="manualLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="menu-screen" class="card hidden">
    <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
    <div class="stats-bar" id="menu-stats" style="margin-top:30px;"></div>
    
    <div id="news-box" class="news-box hidden">
      <h3>ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
      <div id="news-list"></div>
    </div>

    <button class="btn btn-city" onclick="startGame('city')">ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º</button>
    <button class="btn btn-tour" onclick="startGame('tourist')">â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º</button>
    
    <button class="btn btn-dummy" style="margin-top:10px;" onclick="myAlert('é›£èª­åœ°åã‚¯ã‚¤ã‚ºã¯è¿½åŠ äºˆå®šã§ã™ï¼')">ğŸ”’ è¿½åŠ äºˆå®šãƒ¢ãƒ¼ãƒ‰â‘ </button>
    <button class="btn btn-dummy" style="margin-top:10px;" onclick="myAlert('ã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚¯ã‚¤ã‚ºã¯è¿½åŠ äºˆå®šã§ã™ï¼')">ğŸ”’ è¿½åŠ äºˆå®šãƒ¢ãƒ¼ãƒ‰â‘¡</button>

    <button class="btn btn-review" style="margin-top:10px;" onclick="startReview()">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="btn btn-stats" style="margin-top:10px;" onclick="showStatsDetail()">ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</button>
  </div>

  <div id="stats-detail-screen" class="card hidden">
    <h2 style="margin-top:0;">ğŸ“Š ãƒ—ãƒ¬ã‚¤ãƒ‡ãƒ¼ã‚¿</h2>
    <div id="stats-content"></div>
    <button class="btn" onclick="backToMenu()">æˆ»ã‚‹</button>
  </div>

  <div id="game-screen" class="card hidden">
    <div class="stats-bar" id="game-stats">
      <div class="stats-item">æ­£è§£æ•°: <span id="st-correct">0</span></div>
      <div class="stats-item">æ­£è§£ç‡: <span id="st-rate">0%</span></div>
    </div>
    
    <div id="review-banner" class="hidden" style="background:#dc3545; color:white; font-size:12px; padding:2px; margin-bottom:5px; border-radius:4px;">ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­</div>

    <div id="quiz-area">
      <div class="quiz-header" id="q-header">ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ</div>
      <div id="q-img-container"></div>
      <div class="quiz-text" id="q-text"></div>
    </div>
    
    <div style="margin-top: auto;">
      
      <div id="normal-answer-area">
        <select id="answer-select"><option value="" disabled selected>éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        <button class="btn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
        <button class="btn btn-giveup" onclick="giveUp()">ğŸ³ï¸ åˆ†ã‹ã‚‰ãªã„</button>
      </div>

      <div id="hidden-answer-area" class="hidden">
        <button class="btn btn-choice" id="btn-choice-0" onclick="submitHiddenAnswer(0)"></button>
        <button class="btn btn-choice" id="btn-choice-1" onclick="submitHiddenAnswer(1)"></button>
        <button class="btn btn-choice" id="btn-choice-2" onclick="submitHiddenAnswer(2)"></button>
        <button class="btn btn-choice" id="btn-choice-3" onclick="submitHiddenAnswer(3)"></button>
      </div>

      <div style="text-align:center; margin-top:15px;"><button class="btn" style="background:transparent; color:#999; border:none; width:auto; display:inline-block; font-size:12px; padding:5px;" onclick="backToMenu()">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button></div>
    </div>

    <div id="result-overlay" class="result-overlay hidden">
      <div class="res-icon" id="res-icon"></div>
      <div class="res-text" id="res-text"></div>
      <div class="correct-box">
        <span style="font-size:12px; color:#666;">æ­£è§£ã¯...</span><br>
        <span id="res-ans" style="font-size:28px; font-weight:bold; color:#007bff; display:block; margin-bottom:10px;"></span>
      </div>
      
      <div id="link-container" style="display:flex; gap:10px; width:90%; margin-bottom: 20px;">
        <a id="link-map" target="_blank" class="btn" style="background:#4285F4; flex:1; margin:0; padding:10px 0; font-size:14px;">ğŸ—ºï¸ GoogleMap</a>
        <a id="link-wiki" target="_blank" class="btn" style="background:#333; flex:1; margin:0; padding:10px 0; font-size:14px;">ğŸ“– Wikipedia</a>
      </div>

      <button class="btn btn-next" style="width:90%;" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â¡</button>
    </div>
  </div>

  <script>
    // â˜…â˜…â˜…ã“ã“ã«æœ€æ–°ã®GAS URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼â˜…â˜…â˜…
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzv0Gz2d0Ex0NDW8MHuHX6tCKqtGGsUfXrqhQFnar0F0Xw9y5RaFDKz13JZQTh_x2Nk/exec";
    
    let myUserId = null;
    let appData = { stats: null, city: [], tourist: [], news: [], hidden: [] };
    let currentMode = null;
    let currentQuestion = null;
    let wrongList = null; 
    let currentChoices = []; // 4æŠã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”¨

    const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

    window.onload = function() {
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
      const select = document.getElementById('answer-select');
      prefectures.forEach(pref => {
        const option = document.createElement('option');
        option.value = pref; option.textContent = pref; select.appendChild(option);
      });
      const storedName = localStorage.getItem('quiz_app_name');
      const storedPass = localStorage.getItem('quiz_app_pass');
      if (storedName && storedPass) { performLogin(storedName, storedPass); }
      else { document.getElementById('login-screen').classList.remove('hidden'); }
    };

    function myAlert(msg) {
      document.getElementById('alert-msg').innerText = msg;
      document.getElementById('custom-alert').classList.remove('hidden');
    }
    function closeAlert() { document.getElementById('custom-alert').classList.add('hidden'); }

    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    
    function openAdmin() {
      closeSettings();
      document.getElementById('admin-pass-input').value = "";
      document.getElementById('admin-modal').classList.remove('hidden');
    }
    function closeAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
    
    // â˜… ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç…§ä¼š
    async function checkAdmin() {
      const pass = document.getElementById('admin-pass-input').value;
      if (!pass) return myAlert("ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      
      showLoading("èªè¨¼ä¸­...");
      try {
        const url = `${GAS_API_URL}?action=checkAdmin&pass=${encodeURIComponent(pass)}`;
        const res = await fetch(url).then(r => r.json());
        hideLoading();
        closeAdmin();
        
        if (res.success) {
          appData.hidden = res.hiddenQuiz;
          startHiddenQuiz(); // éš ã—ã‚¯ã‚¤ã‚ºèµ·å‹•ï¼
        } else {
          myAlert(res.message);
        }
      } catch(e) {
        hideLoading();
        myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    function manualLogin() {
      const name = document.getElementById('login-name').value;
      const pass = document.getElementById('login-pass').value;
      if(!name || !pass) return myAlert("å…¥åŠ›ã—ã¦ãã ã•ã„");
      performLogin(name, pass);
    }

    async function performLogin(name, pass) {
      showLoading("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...");
      try {
        const url = `${GAS_API_URL}?action=login&name=${encodeURIComponent(name)}&pass=${encodeURIComponent(pass)}`;
        const res = await fetch(url).then(r => r.json());
        onDataLoaded(res, name, pass);
      } catch(e) {
        hideLoading();
        myAlert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        document.getElementById('login-screen').classList.remove('hidden');
      }
    }

    function onDataLoaded(res, name, pass) {
      hideLoading();
      if (!res.success) {
        myAlert(res.message);
        document.getElementById('login-screen').classList.remove('hidden');
        return;
      }
      localStorage.setItem('quiz_app_userid', res.userId);
      localStorage.setItem('quiz_app_name', name);
      localStorage.setItem('quiz_app_pass', pass);
      
      myUserId = res.userId;
      appData.stats = res.stats;
      appData.city = res.masterData.city;
      appData.tourist = res.masterData.tourist;
      appData.news = res.news || []; 
      
      wrongList = null;
      document.getElementById('login-screen').classList.add('hidden');
      showMenu();
    }

    function showMenu() {
      hideAll(); 
      document.getElementById('menu-screen').classList.remove('hidden');
      const s = appData.stats;
      if(s) document.getElementById('menu-stats').innerHTML = `<div class="stats-item">æ­£è§£æ•°: <span>${s.total.correct}</span></div><div class="stats-item">æ­£è§£ç‡: <span>${s.total.rate}%</span></div>`;
      
      const newsBox = document.getElementById('news-box');
      const newsList = document.getElementById('news-list');
      if (appData.news && appData.news.length > 0) {
        newsBox.classList.remove('hidden');
        let html = '';
        appData.news.forEach(n => { html += `<div class="news-item"><span class="news-date">${n.date}</span> ${n.msg}</div>`; });
        newsList.innerHTML = html;
      } else {
        newsBox.classList.add('hidden');
      }
    }

    async function startReview() {
      if (wrongList === null) {
        showLoading("å¾©ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
        try {
          const url = `${GAS_API_URL}?action=getWrongList&userId=${myUserId}`;
          const res = await fetch(url).then(r => r.json());
          if (res.wrongList) { wrongList = res.wrongList; } else { throw new Error(); }
          hideLoading();
        } catch(e) { hideLoading(); return myAlert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
      }
      if (wrongList.length === 0) return myAlert("å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼å„ªç§€ï¼");
      
      currentMode = 'review';
      document.getElementById('review-banner').classList.remove('hidden');
      nextQuestion();
      hideAll(); document.getElementById('game-screen').classList.remove('hidden'); document.getElementById('result-overlay').classList.add('hidden');
    }

    // â˜… éš ã—ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†
    function startHiddenQuiz() {
      currentMode = 'hidden';
      document.getElementById('review-banner').classList.add('hidden');
      nextQuestion();
      hideAll(); 
      document.getElementById('game-screen').classList.remove('hidden'); 
      document.getElementById('result-overlay').classList.add('hidden');
    }

    async function syncScore(isCorrect, syncType, wrongId) {
      if (currentMode === 'hidden') return; // éš ã—ã‚¯ã‚¤ã‚ºã¯æˆç¸¾åŒæœŸã—ãªã„
      const url = `${GAS_API_URL}?action=sync&userId=${myUserId}&mode=${currentMode}&isCorrect=${isCorrect}&syncType=${syncType}&wrongId=${encodeURIComponent(wrongId)}`;
      try {
        const res = await fetch(url).then(r => r.json());
        if(res) appData.stats = res;
      } catch(e) {}
    }
    
    function hideAll() { ['login-screen','menu-screen','game-screen','stats-detail-screen'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
    function showLoading(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    
    function showStatsDetail() {
      hideAll(); document.getElementById('stats-detail-screen').classList.remove('hidden');
      const s = appData.stats;
      const html = `${createStatsCard("ç·åˆãƒ‡ãƒ¼ã‚¿", s.total, "#007bff")}${createStatsCard("ğŸ™ å¸‚ç”ºæ‘ã‚¯ã‚¤ã‚º", s.city, "#28a745")}${createStatsCard("â›©ï¸ è¦³å…‰åœ°ã‚¯ã‚¤ã‚º", s.tourist, "#e67e22")}`;
      document.getElementById('stats-content').innerHTML = html;
    }

    function createStatsCard(title, obj, color) {
      let rateVal = (obj.total > 0) ? ((obj.correct / obj.total) * 100) : 0;
      return `<div class="stats-card" style="border-left-color: ${color}"><h3>${title}</h3><div class="stats-row"><span>å›ç­”æ•°</span><span class="stats-val">${obj.total} å•</span></div><div class="stats-row"><span>æ­£è§£æ•°</span><span class="stats-val">${obj.correct} å•</span></div><div class="progress-bg"><div class="progress-bar" style="width:${rateVal}%; background:${color};"></div></div><div style="text-align:right; font-size:12px; margin-top:2px;">æ­£è§£ç‡: ${obj.rate}%</div></div>`;
    }

    function startGame(mode) {
      currentMode = mode;
      const dataset = (mode === 'city') ? appData.city : appData.tourist;
      if (!dataset || dataset.length === 0) return myAlert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
      document.getElementById('review-banner').classList.add('hidden');
      nextQuestion();
      hideAll(); document.getElementById('game-screen').classList.remove('hidden'); document.getElementById('result-overlay').classList.add('hidden');
    }
    
    function backToMenu() { showMenu(); }
    function logout() { localStorage.removeItem('quiz_app_userid'); localStorage.removeItem('quiz_app_name'); localStorage.removeItem('quiz_app_pass'); location.reload(); }

    function nextQuestion() {
      let q = null;
      
      // UIã®åˆ‡ã‚Šæ›¿ãˆ
      if (currentMode === 'hidden') {
        document.getElementById('normal-answer-area').classList.add('hidden');
        document.getElementById('hidden-answer-area').classList.remove('hidden');
        document.getElementById('q-header').innerText = "ãŠ™ï¸ éš ã—ã‚¯ã‚¤ã‚º ãŠ™ï¸";
        document.getElementById('st-correct').innerText = "ãŠ™ï¸"; 
        document.getElementById('st-rate').innerText = "éš ã‚Œ";
      } else {
        document.getElementById('normal-answer-area').classList.remove('hidden');
        document.getElementById('hidden-answer-area').classList.add('hidden');
        document.getElementById('q-header').innerText = "ã“ã®å ´æ‰€ãŒã‚ã‚‹éƒ½é“åºœçœŒã¯ï¼Ÿ";
      }

      if (currentMode === 'hidden') {
        const randIndex = Math.floor(Math.random() * appData.hidden.length);
        q = appData.hidden[randIndex];
        
        // 4æŠã‚·ãƒ£ãƒƒãƒ•ãƒ«
        currentChoices = [q.a, q.w1, q.w2, q.w3];
        for (let i = currentChoices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [currentChoices[i], currentChoices[j]] = [currentChoices[j], currentChoices[i]];
        }
        for (let i = 0; i < 4; i++) {
          document.getElementById('btn-choice-' + i).innerText = currentChoices[i];
        }

      } else if (currentMode === 'review') {
        if (!wrongList || wrongList.length === 0) { myAlert("å¾©ç¿’å®Œäº†ï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚"); return backToMenu(); }
        const randKey = wrongList[Math.floor(Math.random() * wrongList.length)];
        q = appData.city.find(item => (item.q + "_" + item.a) === randKey) || appData.tourist.find(item => (item.q + "_" + item.a) === randKey);
        if (!q) { wrongList = wrongList.filter(k => k !== randKey); return nextQuestion(); }
        document.getElementById('st-correct').innerText = "-"; document.getElementById('st-rate').innerText = "å¾©ç¿’";
      } else {
        const dataset = (currentMode === 'city') ? appData.city : appData.tourist;
        const randIndex = Math.floor(Math.random() * dataset.length);
        q = dataset[randIndex];
        const s = appData.stats[currentMode];
        document.getElementById('st-correct').innerText = s.correct + '/' + s.total; document.getElementById('st-rate').innerText = s.rate + '%';
      }

      currentQuestion = q;
      document.getElementById('result-overlay').classList.add('hidden');
      document.getElementById('answer-select').selectedIndex = 0;
      document.getElementById('q-text').innerText = currentQuestion.q;
      document.getElementById('q-img-container').innerHTML = currentQuestion.i ? `<img src="${currentQuestion.i}" class="quiz-img">` : '';
    }

    // é€šå¸¸å›ç­”ç”¨
    function submitAnswer() {
      const v = document.getElementById('answer-select').value;
      if(!v) return myAlert("éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„");
      processAnswer(v);
    }
    function giveUp() { processAnswer("GIVE_UP"); }
    
    // éš ã—ã‚¯ã‚¤ã‚º4æŠå›ç­”ç”¨
    function submitHiddenAnswer(index) {
      processAnswer(currentChoices[index]);
    }

    function processAnswer(ans) {
      const isCorrect = (ans === currentQuestion.a);
      let syncType = 'none';
      let qKey = "";

      if (currentMode === 'hidden') {
        // éš ã—ã‚¯ã‚¤ã‚ºã¯æˆç¸¾åæ˜ ã—ãªã„
      } else if (currentMode === 'review') {
        qKey = currentQuestion.q + "_" + currentQuestion.a;
        if (isCorrect) {
          wrongList = wrongList.filter(k => k !== qKey);
          syncType = 'remove';
        }
      } else {
        qKey = currentQuestion.q + "_" + currentQuestion.a;
        updateLocalStats(isCorrect);
        if (!isCorrect) {
          if (wrongList) { if (!wrongList.includes(qKey)) wrongList.push(qKey); }
          syncType = 'add';
        }
      }
      
      showResult(isCorrect, currentQuestion.a);
      if (currentMode !== 'hidden') syncScore(isCorrect, syncType, qKey);
    }

    function updateLocalStats(isCorrect) {
      const s = appData.stats[currentMode]; s.total++; if(isCorrect) s.correct++;
      s.rate = (s.total>0) ? ((s.correct/s.total)*100).toFixed(1) : "0.0";
      const t = appData.stats.total; t.total++; if(isCorrect) t.correct++;
      t.rate = (t.total>0) ? ((t.correct/t.total)*100).toFixed(1) : "0.0";
    }

    function showResult(isCorrect, ans) {
      const overlay = document.getElementById('result-overlay');
      const icon = document.getElementById('res-icon');
      const text = document.getElementById('res-text');
      overlay.classList.remove('hidden');
      if(isCorrect) { icon.innerText = 'â­•'; text.innerText = 'æ­£è§£ï¼'; text.style.color = '#28a745'; }
      else { icon.innerText = 'âŒ'; text.innerText = 'æ®‹å¿µ...'; text.style.color = '#dc3545'; }
      
      document.getElementById('res-ans').innerText = ans;

      // Wiki/Mapãƒªãƒ³ã‚¯ã®åˆ¶å¾¡ï¼ˆéš ã—ã‚¯ã‚¤ã‚ºã¯ç„¡åŠ¹åŒ–ï¼‰
      if (currentMode === 'hidden') {
        document.getElementById('link-container').classList.add('hidden');
      } else {
        document.getElementById('link-container').classList.remove('hidden');
        const searchQuery = currentQuestion.a + " " + currentQuestion.n; 
        document.getElementById('link-map').href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(searchQuery);
        document.getElementById('link-wiki').href = "https://ja.wikipedia.org/wiki/" + encodeURIComponent(currentQuestion.n);
      }
    }
  </script>
</body>
</html>
